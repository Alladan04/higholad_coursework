# Проектирование высоконагруженной системы на примере eBay
## Содержание
1. [Тема и целевая аудитория](#1-тема-и-целевая-аудитория)
   1. [Основной функционал сервиса](#основной-функционал-сервиса)
   2. [Целевая аудитория](#целевая-аудитория)
   3. [Основные продуктовые решения](#основные-продуктовые-решения)
2. [Расчет нагрузки](#2-расчет-нагрузки)
   1. [Продуктовые метрики](#продуктовые-метрики)
   2. [Средний размер хранилища пользователя](#средний-размер-хранилища-пользователя)
   3. [Запросы пользователей в день и RPS](#запросы-пользователей-в-день-и-rps)
   4. [Сетевой трафик ](#сетевой-трафик)
3. [Глобальная балансировка нагрузки](#3-глобальная-балансировка-нагрузки)
   1. [Обоснование расположения ЦОДов](#обоснования-расположения-цодов)
   2. [Расчет распределения нагрузки по ЦОДам](#расчет-распределения-запросов-по-цодам)
   3. [DNS балансировка](#dns-балансировка)
   4. [CDN](#cdn)
   5. [BGP Anycast](#bgp-anycast)
4. Локальная балансировка нагрузки
5. Логическая схема данных
6. [Использованные ресурсы](#использованные-ресурсы)
## 1. Тема и целевая аудитория
**eBay** - американская компания, предоставляющая услуги в областях 
интернет-аукционов и интернет-магазинов. Основан в 1995 году как первая в мире площадка 
для проведения интернет аукционов. С тех пор сервис активно развивается и на данный момент является
одним из крупнейших маркетплейсов.
### Основной функционал сервиса
* Список объявлений
* Поиск объявлений
* Работа с объявлением (создание, редактирование, удаление)
* Просмотр объявления
* Модерация объявлений
* Профиль пользователя
* Оценить продавца
* Рейтинг продавца
* Статитстика продаж
* Купить товар сразу
* Участвовать в аукционе (сделать ставку)
### Целевая аудитория

По данным с [hypestat](https://hypestat.com/info/ebay.com) и [отчетов ebay.com](https://investors.ebayinc.com/overview/default.aspx):
* 632+ млн сессий в месяц
* 18 млн активных продавцов (активными считаются продавцы, которые опубликовали хотя бы 1 объявление за предыдущие 12 месяцев)
* 132 млн активных покупателей (активными считаются покупатели, которые совершили хотя бы 1 покупку в предыдущие 12 месяцев)
* 135 млн активных пользоввателей суммарно
* 20+ млн сессий в день
* 146+ млн страниц просматривается посетителями ежедневно
* Основная часть покупателей сервиса (≈81%) находится в США
* 2+ млрд активных объявлений

### Основные продуктовые решения:
* Главная модель совершения сделок - аукцион.
* Альтернативная модель совершения сделок в виде функции "Купить сейчас".
* Рекомендательная система на основе действий, совершенных пользователем ранее.
## 2. Расчет нагрузки
### Продуктовые метрики
| Метрика                  | Значение              |
|--------------------------|-----------------------|
| Месячная аудитория MAU** | 45 млн. пользователей |
| Дневная аудитория DAU*   | 18 млн. пользователей |
*Из предположения, что количество уникальных пользователей в день на 10% меньше, чем количество сессий\
** Вычислено исходя из соотношения MAU/DAU аналогичных ресурсов

### Средний размер хранилища пользователя
| Данные                               | Размер ед.      | Кол-во на 1 пользователя | Суммарный объем |
|--------------------------------------|-----------------|--------------------------|-----------------|
| Профиль пользователя (Аватар + ПД)   | 70Кб + 2Кб      | 1                        | 9,05 Tб         |
| Oбъявление (Фотографии + информация) | 120Кб * 5 + 2Кб | 111 (на 1 продавца)      | 1,1 Пб          |
| Отзывы                               | 1Кб             | 2000  (на 1 продавца)    | 33,5 Тб         |
| Статистические данные по покупателям | 300Байт         | 1000  ( на 1 покупателя) | 36 Тб           |

### Запросы пользователей в день и RPS

Данных по действиям пользователей в день в открытом доступе нет.\
Всего поользователями просматривается порядка 146млн страниц в день => каждый пользователь просматривает примерно 146млн/18млн ≈ 8 страниц в день.
RPS = среднее_кол-во_действий_в_день * DAU / 86400

| Действие                                                | Среднее количество в день на пользователя | RPS |
|---------------------------------------------------------|:-----------------------------------------:|-----|
| Просмотр списка объявлений                              |                    1,6                    | 333 |
| Поиск                                                   |                    2,7                    | 562 |
| Работа с объявлением (создание/редактирование/удаление) |                    0,9                    | 187 |
| Просмотр объявления                                     |                    1,4                    | 291 |
| Регистрация/авторизация                                 |                    0,3                    | 62  |
| Профиль пользователя                                    |                    0,4                    | 83  |
| Оценка продавца                                         |                    0,2                    | 41  |
| Просмотр статистики продаж                              |                    0,2                    | 41  |
| Совершение покупки/ставки                               |                    0,3                    | 62  |
| Модерация                                               |                     _                     | 100 |

**Пояснение:**
В [исследовании архитектуры ebay](https://www.softwaresecretweapons.com/jspwiki/resources/presentations/Sun_eBay6-2_forWeb.pdf) указывается,
что 65% от всего трафика ресурса приходится на просмотр объявлений => 5 из 8 просмотренных страниц за сессию - это 
просмотр объявлений (будем исходить из того, что это включает поиск, просмотр списка объявлений и просмотр страницы одного объявления).\
По данным [статьи ](https://o2k.ru/blog/srednyaya-konversiya) можно сделать вывод, что в среднем конверсия в покупку составляет порядка 3%.\
Запросы на модерацию происходят со стороны сотрудников компании, поэтому не могут быть посчитаны аналогично остальным запросам. 
Но можно предположить, что они происходят 1-2 раза на каждое опубликованное объявление.

Получаем средний RPS : 1753. Заложим на пиковый RPS х2 от среднего.\
Получим **пиковую нагрузку в 3506 RPS**.

### Сетевой трафик

Нагрузку на сеть можно расчитать по формуле: нагрузка[Гбит/c] = средний_трафик_на_действие * RPS * 8 / 1024 / 1024

| Действие                                                | Средний трафик на одно действие | Нагрузка на сеть |
|---------------------------------------------------------|:-------------------------------:|------------------|
| Просмотр списка объявлений/ Поиск                       |             2600 Кб             | 17,75 Гбит/с     |
| Работа с объявлением (создание/редактирование/удаление) |             720 Кб              | 1,02 Гбит/с      |
| Просмотр объявления                                     |             870 Кб              | 1,93 Гбит/с      |
| Профиль пользователя                                    |             500 КБ              | 0,32 Гбит/с      |
| Регистрация/авторизация                                 |             100 Кб              | 0,04 Гбит/с      |
| Оценка продавца                                         |             100 Кб              | 0,03 Гбит/с      |
| Просмотр статистики продаж                              |             320 Кб              | 0,10 Гбит/с      |
| Совершение покупки/ставки                               |             250 Кб              | 0,11 Гбит/с      |
| Модерация                                               |             250 Кб              | 0,19 Гбит/с      |

 
Суммарная нагрузка на сеть: 21,49 Гбит/с \
Пусть пиковая нагрузка будет в 2 раз больше, чем средняя (также как для RPS). **Получаем пиковую нагрузку: 42,98 Гбит/с**

## 3. Глобальная балансировка нагрузки

### Обоснования расположения ЦОДов

В пункте [1. Тема и целевая аудитория](#1-тема-и-целевая-аудитория) обозначили, что более 80% траффика на сервис приходит с территории США.
Однако не смотря на это сервис обслуживает пользователей по всему миру: Европа, Азия, Южная Америка и даже Австралия.

Болшую часть ЦОДов имеет смысл установить на территории США, для этого можно выбрать следующие города:
- Питтсбург, штат Пенсильвания
- Портленд, штат Орегон
- Денвер, штат Колорадо
- Финикс, штат Аризона 

### Расчет распределения запросов по ЦОДам

Будем ориентироваться на карту плотности населения США и географическое положение наших ЦОД: ![map](map.png) 

| ЦОД       | Примерная область покрытия            | Приблизительный % пользователей | DAU (млн.) | RPS  | Пиковые значения RPS |
|-----------|---------------------------------------|---------------------------------|------------|------|----------------------|
| Питтсбург | Восточная часть США, Европа           | 40                              | 7,2        | 701  | 1402                 |
| Портленд  | Западная часть США, Китай             | 25                              | 4,5        | 438  | 876                  |
| Финикс    | Южная часть США, страны Южной Америки | 15                              | 2,7        | 263  | 526                  |
| Денвер    | Северная и центральная части США      | 20                              | 3,6        | 351  | 702                  |

### DNS-балансировка

Для балансировки нагрузки по регионам будем использовать Latency-based DNS, который будет отправлять запросы клиентов на те
ЦОДы, где минимальный RTT.

[//]: # ()
[//]: # (### CDN)

[//]: # ()
[//]: # (Для снижения времени загрузки страниц и контента будем использовать CDN: контент может быть кэширован на серверах, распределенных)

[//]: # (географически, и пользователь будет получать контент с ближайшего.)

### BGP Anycast

В каждом из регионов будем использовать BGP Anycast. Так сможем направить запросы клиентов к 
ближайшему узлу внутри их региона и благодаря этому повысим скорость обработки запросов.

## 4. Локальная балансировка нагрузки
### L7 балансировка
В качестве L7 балансировщика выберем envoy, с помощью него будем распределять запросы между сервисами, поднятыми в k8s.
Также envoy позволяет реализовать кеширование запросов, что позволит решить проблему медленных клиентов. 
Одним из преимуществ envoy также является возможность динамического изменения конфигурации.

### k8s
Система оркестрации k8s умеет самостоятельно распределять нагрузку между подами, а также позволяет выполнять автоматическую регуляцию ресурсов в зависимости от нагрузки.

### Отказоустойчивость
Для обеспечения отказоустойчивости системы используем keepalived - реализацию протокола VRRP. 
Таким образом, если один из наших активных серверов будет сбоить - его адрес будет делегирован другому серверу.

В связке с такими возомжностями envoy, как ретраи, мониторинг и circuit breaker получим достаточно высокую отказоустойчивость нашей системы.

### SSL termination:
Для того чтобы снять нагрузку с серверов по расшифровке SSL, это будет делать L7 балансировщик.
## 5. Логическая схема базы данных
### ER диаграмма
   ![ER.svg](ER.svg)
### Расчет размера данных
| Тип       | Размер (в байтах) |
|-----------|-------------------|
| BIGINT    | 8                 |
| CHAR      | 1                 |
| INT       | 4                 |
| TIMESTAMP | 8                 |

**Listing**
```TeX
  LisingID(8) + OwnerID (8) + CategoryID (8) + Title (200) + Price (8) + Description (1000) + SellModel (4) + ImageSource (1000) + Rating (4) + Status (4) + PublicationDate (8) = 2252 байта
``` 
**Profile**
```TeX
   ProfileID (8) + Username (100) + PasswordHash (200) + ImageSource (200) + Phone (50) + Email (50) + Rating (4) + RegistrationDate (8) = 620 байт
``` 
**Auction**
```TeX
   AuctionID (8) + ListingID (8) + LastBidID (8) + CurrentPrice (8) + Step (8) + Status (4) =  44 байта
```

**Bid**
```TeX
   BidID (8) + AuctionID (8) + BuyerID (8) + CreatedAt (8) =  32 байта
```

**Order**
```TeX
  OrderID (8) + ListingID (8) + BuyerID (8) + SellerID (8) + AddressID (8) + Status (4) + CreatedAt (8) = 52 байта
```
**Address**
```TeX
  AddressID (8) + ProfileID (8) + Country (50) + City (50) + Street (100) + House (50) + Flat (50) = 316 байт
```
**Category**
```TeX
  CategoryID (8) + ParentID (8) + Title (200) = 216 байт
```

**Comment**
```TeX
  CommentID (8) + CommentatorID (8) + ListingID (8) + CreatedAt (8) + Mark (4) = 36 байт
  
```
**UserAction**
```TeX
  ActionID (8) + ListingID (8) + UserID (8) + Type (4) + Time (8) = 36 байт
  
```
| Таблица        | Размер записи (байт) | Количество записей | Итого |
|----------------|----------------------|--------------------|-------|
| **Listing**    | 2252                 | 2 млрд             |       |
| **Profile**    | 620                  | 135 млн            |       |
| **Auction**    | 44                   | 800 млн            |       |
| **Bid**        | 32                   | 1.7 млрд           |       |
| **Order**      | 52                   |                    |       |
| **Address**    | 316                  |                    |       |
| **Category**   | 216                  |                    |       |
| **Comment**    | 36                   |                    |       |
| **UserAction** | 36                   |                    |       |

| Таблица        | Чтение (QPS) | Запись (QPS) |
|----------------|--------------|--------------|
| **Listing**    |              |              |
| **Profile**    |              |              |
| **Auction**    |              |              |
| **Bid**        |              |              |
| **Order**      |              |              |
| **Address**    |              |              |
| **Category**   |              |              |
| **Comment**    |              |              |
| **UserAction** |              |              |

---
## Использованные ресурсы:
1. https://hypestat.com/info/ebay.com
2. https://www.ebayinc.com/company/
3. https://investors.ebayinc.com/overview/default.aspx
4. [eBay Creates Technology Architecture for the Future By David S. Marshak](https://www.softwaresecretweapons.com/jspwiki/resources/presentations/Sun_eBay6-2_forWeb.pdf) 
