# Проектирование высоконагруженной системы на примере eBay
## Содержание
1. [Тема и целевая аудитория](#1-тема-и-целевая-аудитория)
   1. [Основной функционал сервиса](#основной-функционал-сервиса)
   2. [Целевая аудитория](#целевая-аудитория)
   3. [Основные продуктовые решения](#основные-продуктовые-решения)
2. [Расчет нагрузки](#2-расчет-нагрузки)
   1. [Продуктовые метрики](#продуктовые-метрики)
   2. [Средний размер хранилища пользователя](#средний-размер-хранилища-пользователя)
   3. [Запросы пользователей в день и RPS](#запросы-пользователей-в-день-и-rps)
   4. [Сетевой трафик ](#сетевой-трафик)
3. [Использованные ресурсы](#использованные-ресурсы)
## 1. Тема и целевая аудитория
**eBay** - американская компания, предоставляющая услуги в областях 
интернет-аукционов и интернет-магазинов. Основан в 1995 году как первая в мире площадка 
для проведения интернет аукционов. С тех пор сервис активно развивается и на данный момент является
одним из крупнейших маркетплейсов.
### Основной функционал сервиса
* Список объявлений
* Поиск объявлений
* Работа с объявлением (создание, редактирование, удаление)
* Просмотр объявления
* Модерация объявлений
* Профиль пользователя
* Оценить продавца
* Рейтинг продавца
* Статитстика продаж
* Купить товар сразу
* Участвовать в аукционе (сделать ставку)
### Целевая аудитория

По данным с [hypestat](https://hypestat.com/info/ebay.com) и [отчетов ebay.com](https://investors.ebayinc.com/overview/default.aspx):
* 632+ млн сессий в месяц
* 18 млн активных продавцов (активными считаются продавцы, которые опубликовали хотя бы 1 объявление за предыдущие 12 месяцев)
* 132 млн активных покупателей (активными считаются покупатели, которые совершили хотя бы 1 покупку в предыдущие 12 месяцев)
* 135 млн активных пользоввателей суммарно
* 20+ млн сессий в день
* 146+ млн страниц просматривается посетителями ежедневно
* Основная часть покупателей сервиса (≈81%) находится в США
* 2+ млрд активных объявлений

### Основные продуктовые решения:
* Главная модель совершения сделок - аукцион.
* Альтернативная модель совершения сделок в виде функции "Купить сейчас".
* Рекомендательная система на основе действий, совершенных пользователем ранее.
## 2. Расчет нагрузки
### Продуктовые метрики
| Метрика                | Значение               |
|------------------------|------------------------|
| Месячная аудитория MAU | 630 млн. пользователей |
| Дневная аудитория DAU  | 20 млн. пользователей  |

### Средний размер хранилища пользователя
| Данные                               | Размер ед.      | Кол-во на 1 пользователя | Суммарный объем |
|--------------------------------------|-----------------|--------------------------|-----------------|
| Профиль пользователя (Аватар + ПД)   | 70Кб + 2Кб      | 1                        | 9,05 Tб         |
| Oбъявление (Фотографии + информация) | 120Кб * 5 + 2Кб | 111 (на 1 продавца)      | 1,1 Пб          |
| Отзывы                               | 1Кб             | 2000  (на 1 продавца)    | 33,5 Тб         |
| Статистические данные по покупателям | 300Байт         | 1000  ( на 1 покупателя) | 36 Тб           |

### Запросы пользователей в день и RPS

Данных по действиям пользователей в день в открытом доступе нет.\
Можно использовать данные из [hypestat](https://hypestat.com/info/ebay.com), согласно 
которым пользователь посещает 7 страниц за сессию.
RPS = среднее_кол-во_действий_в_день * DAU / 86400

| Действие                                                | Среднее количество в день на пользователя | RPS |
|---------------------------------------------------------|:-----------------------------------------:|-----|
| Просмотр списка объявлений                              |                    1,1                    | 254 |
| Поиск                                                   |                     1                     | 231 |
| Работа с объявлением (создание/редактирование/удаление) |                    0,3                    | 69  |
| Просмотр объявления                                     |                     4                     | 925 |
| Регистрация/авторизация                                 |                    0,2                    | 46  |
| Профиль пользователя                                    |                    0,1                    | 23  |
| Оценка продавца                                         |                    0,1                    | 23  |
| Просмотр статистики продаж                              |                    0,1                    | 23  |
| Совершение покупки/ставки                               |                    0,1                    | 23  |
| Модерация                                               |                     _                     | 23  |

**Пояснение:**
В [исследовании архитектуры ebay](https://www.softwaresecretweapons.com/jspwiki/resources/presentations/Sun_eBay6-2_forWeb.pdf) указывается,
что 65% от всего трафика ресурса приходится на просмотр объявлений => 4 из 7 просмотренных страниц за сессию - это просмотр объявлений.\
По данным [статьи ](https://o2k.ru/blog/srednyaya-konversiya) можно сделать вывод, что в среднем конверсия в покупку составляет порядка 3%.\
Запросы на модерацию происходят со стороны сотрудников компании, поэтому не могут быть посчитаны аналогично остальным запросам. 
Но можно предположить, что они происходят 1-2 раза на каждое опубликованное объявление.

Получаем средний RPS : 1640. Заложим на пиковый RPS х2 от среднего.\
Получим **пиковую нагрузку в 3280 RPS**.

### Сетевой трафик

Нагрузку на сеть можно расчитать по формуле: нагрузка[Гбит/c] = средний_трафик_на_действие * RPS * 8 / 1024 / 1024

| Действие                                                | Средний трафик на одно действие | Нагрузка на сеть |
|---------------------------------------------------------|:-------------------------------:|------------------|
| Просмотр списка объявлений/ Поиск                       |             2600 Кб             | 9,60 Гбит/с      |
| Работа с объявлением (создание/редактирование/удаление) |             720 Кб              | 0,38 Гбит/с      |
| Просмотр объявления                                     |             870 Кб              | 6,10 Гбит/с      |
| Профиль пользователя                                    |             500 КБ              | 0,08 Гбит/с      |
| Оценка продавца                                         |             100 Кб              | 0,02 Гбит/с      |
| Просмотр статистики продаж                              |             320 Кб              | 0,06 Гбит/с      |
| Совершение покупки/ставки                               |             250 Кб              | 0,04 Гбит/с      |

 
Суммарная нагрузка на сеть: 16,28 Гбит/с \
Пусть пиковая нагрузка будет в 2 раз больше, чем средняя (также как для RPS). **Получаем пиковую нагрузку: 32,56 Гбит/с**

## 3. Глобальная балансировка нагрузк
Разделим нашу нагрузку на следующие домены:
- ebay.com - основной домен, на который направляются запросы, связанные с объявлениями и профилями пользователей.
- pay.ebay.com - домен отвечающий за оплату товара. 
- order.ebay.com - домен, который отвечает за обработку заказа после оплаты.
- signin.ebay.com - домен для регистрации/авторизации.
- moderate.ebay.com - домен обработки объявлений модераторами.



## Использованные ресурсы:
1. https://hypestat.com/info/ebay.com
2. https://www.ebayinc.com/company/
3. https://investors.ebayinc.com/overview/default.aspx
4. [eBay Creates Technology Architecture for the Future By David S. Marshak](https://www.softwaresecretweapons.com/jspwiki/resources/presentations/Sun_eBay6-2_forWeb.pdf) 
